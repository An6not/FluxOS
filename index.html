<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>AnnotCraft: Ultra Stable</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/0.160.0/three.min.js"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --mc-bg: #c6c6c6; --mc-light: #ffffff; --mc-dark: #555555; }
        body, html { 
            margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; 
            background: #000; font-family: 'Courier New', monospace;
            user-select: none; touch-action: none;
        }

        /* Minecraft UI - Фикс двойных теней */
        .mc-screen { position: absolute; inset: 0; z-index: 1000; display: flex; align-items: center; justify-content: center; background: rgba(0,0,0,0.8); }
        .mc-panel { 
            background: var(--mc-bg); border: 4px solid #000; 
            box-shadow: inset 4px 4px var(--mc-light), inset -4px -4px var(--mc-dark);
            padding: 20px; width: 310px; text-align: center;
        }
        .mc-btn {
            background: #7c7c7c; border: 2px solid #000;
            box-shadow: inset 2px 2px var(--mc-light), inset -2px -2px var(--mc-dark);
            color: white; padding: 12px; margin: 8px 0; width: 100%; font-weight: bold;
            text-shadow: 2px 2px #000; cursor: pointer; font-size: 14px;
        }
        .mc-btn:active { box-shadow: inset -2px -2px var(--mc-light), inset 2px 2px var(--mc-dark); transform: translateY(2px); }
        
        /* HUD & Controls */
        #hud { position: absolute; top: 10px; left: 10px; color: #fff; text-shadow: 2px 2px #000; pointer-events: none; z-index: 500; }
        #top-btns { position: absolute; top: 10px; right: 10px; display: flex; gap: 5px; z-index: 1100; }
        .small-btn { padding: 8px; background: rgba(0,0,0,0.6); color: #fff; border: 2px solid #fff; font-size: 10px; border-radius: 4px; }

        #ui-layer { position: absolute; inset: 0; pointer-events: none; display: none; }
        #joy-base { position: absolute; bottom: 40px; left: 40px; width: 120px; height: 120px; background: rgba(255,255,255,0.1); border: 3px solid #fff; border-radius: 50%; pointer-events: auto; }
        #joy-stick { position: absolute; top: 35px; left: 35px; width: 50px; height: 50px; background: #fff; border-radius: 50%; opacity: 0.6; }
        #actions { position: absolute; bottom: 25px; right: 20px; display: flex; flex-direction: column; gap: 10px; pointer-events: auto; }
        .act-btn { width: 70px; height: 70px; background: rgba(0,0,0,0.4); border: 4px solid #fff; color: #fff; font-weight: bold; display: flex; align-items: center; justify-content: center; border-radius: 12px; }
        
        #toolbar { position: absolute; bottom: 15px; left: 50%; transform: translateX(-50%); display: flex; gap: 5px; background: rgba(0,0,0,0.8); padding: 5px; border: 3px solid #444; pointer-events: auto; }
        .slot { width: 40px; height: 40px; border: 2px solid #666; }
        .slot.active { border-color: #fff; background: rgba(255,255,255,0.3); }
        #crosshair { position: absolute; top: 50%; left: 50%; width: 20px; height: 20px; border: 2px solid #fff; transform: translate(-50%, -50%); pointer-events: none; opacity: 0.6; }
    </style>
</head>
<body>

    <div id="top-btns">
        <button class="small-btn" onclick="smartResize()">РАЗМЕР</button>
        <button class="small-btn" onclick="switchM('settings')">МЕНЮ</button>
    </div>

    <div id="hud">FPS: <span id="fps">0</span><br>AnnotCraft v6.0</div>
    <div id="crosshair" style="display:none"></div>

    <div id="m-main" class="mc-screen">
        <div class="mc-panel">
            <h1 style="color:#fff; text-shadow: 3px 3px #000; margin:0 0 20px 0;">ANNOT CRAFT</h1>
            <button class="mc-btn" onclick="runGame('single')">ОДИНОЧНЫЙ МИР</button>
            <button class="mc-btn" onclick="switchM('multi')">СЕТЕВАЯ ИГРА</button>
            <button class="mc-btn" onclick="switchM('settings')">НАСТРОЙКИ</button>
        </div>
    </div>

    <div id="m-multi" class="mc-screen" style="display:none">
        <div class="mc-panel">
            <h2 style="color:#fff;">МУЛЬТИПЛЕЕР</h2>
            <input type="text" id="srv-id" style="width:100%; padding:10px; background:#000; color:#0f0; border:2px solid #555; margin-bottom:10px;" placeholder="ID комнаты">
            <button class="mc-btn" onclick="runGame('host')">СОЗДАТЬ</button>
            <button class="mc-btn" onclick="runGame('join')">ВОЙТИ</button>
            <button class="mc-btn" onclick="switchM('main')">НАЗАД</button>
        </div>
    </div>

    <div id="m-settings" class="mc-screen" style="display:none">
        <div class="mc-panel">
            <h2 style="color:#fff;">НАСТРОЙКИ</h2>
            <button class="mc-btn" onclick="toggleView()">ВИД: <span id="v-txt">1 ЛИЦО</span></button>
            <button class="mc-btn" onclick="closeM()">ПРОДОЛЖИТЬ</button>
            <button class="mc-btn" onclick="location.reload()" style="color:#ff4444">ВЫЙТИ</button>
        </div>
    </div>

    <div id="ui-layer">
        <div id="toolbar">
            <div class="slot active" id="s0" onclick="setB('DIRT',0)"><div style="width:30px;height:30px;background:#8b4513;margin:5px"></div></div>
            <div class="slot" id="s1" onclick="setB('STONE',1)"><div style="width:30px;height:30px;background:#808080;margin:5px"></div></div>
            <div class="slot" id="s2" onclick="setB('WOOD',2)"><div style="width:30px;height:30px;background:#6d4c41;margin:5px"></div></div>
            <div class="slot" id="s3" onclick="setB('LEAVES',3)"><div style="width:30px;height:30px;background:#2e7d32;margin:5px"></div></div>
        </div>
        <div id="actions">
            <div class="act-btn" id="b-jump">JUMP</div>
            <div class="act-btn" id="b-break" style="color:red">BREAK</div>
            <div class="act-btn" id="b-place" style="color:lime">PLACE</div>
        </div>
        <div id="joy-base"><div id="joy-stick"></div></div>
    </div>

    <script>
        /** --- ASSETS (Core) --- **/
        function createTex(c1, c2, side=false) {
            const canv = document.createElement('canvas'); canv.width = 16; canv.height = 16;
            const ctx = canv.getContext('2d');
            for(let x=0; x<16; x++) {
                for(let y=0; y<16; y++) {
                    ctx.fillStyle = Math.random() > 0.8 ? c2 : c1;
                    if(side && y < 5) ctx.fillStyle = '#5a9a44';
                    ctx.fillRect(x, y, 1, 1);
                }
            }
            const t = new THREE.CanvasTexture(canv);
            t.magFilter = t.minFilter = THREE.NearestFilter;
            return t;
        }

        const MATS = {
            DIRT: new THREE.MeshLambertMaterial({ map: createTex('#8b4513', '#603010') }),
            STONE: new THREE.MeshLambertMaterial({ map: createTex('#808080', '#666666') }),
            WOOD: new THREE.MeshLambertMaterial({ map: createTex('#6d4c41', '#4d3020') }),
            LEAVES: new THREE.MeshLambertMaterial({ map: createTex('#1b5e20', '#2e7d32'), transparent:true, opacity:0.8 }),
            GRASS: [
                new THREE.MeshLambertMaterial({ map: createTex('#8b4513', '#5a9a44', true) }),
                new THREE.MeshLambertMaterial({ map: createTex('#8b4513', '#5a9a44', true) }),
                new THREE.MeshLambertMaterial({ map: createTex('#5a9a44', '#4e8a3a') }),
                new THREE.MeshLambertMaterial({ map: createTex('#8b4513', '#603010') }),
                new THREE.MeshLambertMaterial({ map: createTex('#8b4513', '#5a9a44', true) }),
                new THREE.MeshLambertMaterial({ map: createTex('#8b4513', '#5a9a44', true) })
            ]
        };

        /** --- ИГРОК --- **/
        function createSteve(color) {
            const g = new THREE.Group();
            const skin = new THREE.MeshLambertMaterial({color: color});
            const head = new THREE.Mesh(new THREE.BoxGeometry(0.4,0.4,0.4), skin); head.position.y = 1.6;
            const body = new THREE.Mesh(new THREE.BoxGeometry(0.4,0.7,0.2), new THREE.MeshLambertMaterial({color:0x00aaff})); body.position.y = 1.05;
            const limb = new THREE.BoxGeometry(0.18, 0.7, 0.18);
            const aL = new THREE.Mesh(limb, skin); aL.position.set(-0.3, 1.05, 0);
            const aR = new THREE.Mesh(limb, skin); aR.position.set(0.3, 1.05, 0);
            const lL = new THREE.Mesh(limb, new THREE.MeshLambertMaterial({color:0x000088})); lL.position.set(-0.1, 0.35, 0);
            const lR = lL.clone(); lR.position.x = 0.1;
            g.add(head, body, aL, aR, lL, lR);
            g.parts = { aL, aR, lL, lR };
            return g;
        }

        /** --- ГЛОБАЛЬНЫЕ ПЕРЕМЕННЫЕ --- **/
        let scene, camera, renderer, sun, skyColor = new THREE.Color(0x87ceeb);
        let world = new Map(), players = {}, selB = 'DIRT', vY = 0, isGrounded = false;
        let joyId, camId, lx, ly, moveVec = {x:0, z:0}, lastT = 0;
        let isFP = true, dayTime = 0, peer, conn;

        function switchM(m) { document.querySelectorAll('.mc-screen').forEach(s=>s.style.display='none'); document.getElementById('m-'+m).style.display='flex'; }
        function closeM() { document.querySelectorAll('.mc-screen').forEach(s=>s.style.display='none'); }
        function setB(m, i) { selB = m; document.querySelectorAll('.slot').forEach(s=>s.classList.remove('active')); document.getElementById('s'+i).classList.add('active'); }

        function toggleView() {
            isFP = !isFP;
            document.getElementById('v-txt').innerText = isFP ? "1 ЛИЦО" : "3 ЛИЦО";
            if(players.me) {
                players.me.visible = !isFP;
                camera.position.set(0, isFP ? 1.6 : 3, isFP ? 0 : -4);
                if(!isFP) camera.lookAt(0, 1, 0);
            }
        }

        function smartResize() {
            if(!renderer) return;
            const w = window.innerWidth, h = window.innerHeight;
            renderer.setSize(w, h);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 1.5));
            camera.aspect = w / h;
            camera.updateProjectionMatrix();
        }

        /** --- ЗАПУСК --- **/
        function runGame(m) {
            if(m === 'single') startWorld();
            else {
                const id = document.getElementById('srv-id').value || "room123";
                peer = (m === 'host') ? new Peer("annot6_" + id) : new Peer();
                peer.on('open', () => {
                    if(m==='host') peer.on('connection', c => { conn = c; setupNet(); });
                    else { conn = peer.connect("annot6_" + id); setupNet(); }
                });
            }
        }

        function setupNet() { conn.on('open', () => startWorld()); conn.on('data', d => handleNet(d)); }
        function handleNet(d) {
            if(d.type==='sync') {
                if(!players.f) { players.f = createSteve(0xffccaa); scene.add(players.f); }
                players.f.position.lerp(new THREE.Vector3(d.x, d.y, d.z), 0.3);
                players.f.rotation.y = d.ry;
            }
            if(d.type==='place') build(d.pos, d.mat, false);
            if(d.type==='break') destroy(d.pos, false);
        }

        function startWorld() {
            closeM();
            document.getElementById('ui-layer').style.display = 'block';
            document.getElementById('crosshair').style.display = 'block';

            scene = new THREE.Scene();
            scene.background = skyColor;
            camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 100);
            
            renderer = new THREE.WebGLRenderer({ antialias: false, powerPreference: "high-performance", precision: "mediump" });
            document.body.appendChild(renderer.domElement);
            smartResize();

            scene.add(new THREE.AmbientLight(0xffffff, 0.6));
            sun = new THREE.DirectionalLight(0xffffff, 0.7);
            scene.add(sun);

            // Генерация пола
            const geo = new THREE.BoxGeometry(1,1,1);
            for(let x=-15; x<=15; x++) {
                for(let z=-15; z<=15; z++) {
                    const b = new THREE.Mesh(geo, MATS.GRASS);
                    b.position.set(x, 0, z);
                    scene.add(b); world.set(`${x},0,${z}`, b);
                }
            }

            players.me = createSteve(0x00ff88);
            players.me.position.set(0, 5, 0);
            scene.add(players.me);
            players.me.add(camera);
            players.me.visible = false;
            camera.position.set(0, 1.6, 0);

            initControls();
            loop();
        }

        function build(p, m, s) {
            const k = `${Math.round(p.x)},${Math.round(p.y)},${Math.round(p.z)}`;
            if(world.has(k)) return;
            const b = new THREE.Mesh(new THREE.BoxGeometry(1,1,1), MATS[m]);
            b.position.set(Math.round(p.x), Math.round(p.y), Math.round(p.z));
            scene.add(b); world.set(k, b);
            if(s && conn) conn.send({type:'place', pos: b.position, mat: m});
        }

        function destroy(p, s) {
            const k = `${Math.round(p.x)},${Math.round(p.y)},${Math.round(p.z)}`;
            if(world.has(k) && Math.round(p.y) !== 0) {
                scene.remove(world.get(k)); world.delete(k);
                if(s && conn) conn.send({type:'break', pos: p});
            }
        }

        function initControls() {
            const ray = new THREE.Raycaster();
            document.getElementById('b-jump').onpointerdown = () => { if(isGrounded) vY = 0.23; };
            document.getElementById('b-place').onpointerdown = () => {
                ray.setFromCamera(new THREE.Vector2(0,0), camera);
                const h = ray.intersectObjects(Array.from(world.values()));
                if(h.length > 0) build(h[0].point.add(h[0].face.normal.multiplyScalar(0.5)), selB, true);
            };
            document.getElementById('b-break').onpointerdown = () => {
                ray.setFromCamera(new THREE.Vector2(0,0), camera);
                const h = ray.intersectObjects(Array.from(world.values()));
                if(h.length > 0) destroy(h[0].object.position, true);
            };

            window.addEventListener('touchstart', e => {
                for(let t of e.changedTouches) {
                    if(t.clientX < window.innerWidth/2) joyId = t.identifier;
                    else { camId = t.identifier; lx = t.clientX; ly = t.clientY; }
                }
            });
            window.addEventListener('touchmove', e => {
                for(let t of e.changedTouches) {
                    if(t.identifier === joyId) {
                        const r = document.getElementById('joy-base').getBoundingClientRect();
                        const dx = t.clientX - (r.left+60), dy = t.clientY - (r.top+60);
                        const d = Math.min(45, Math.sqrt(dx*dx+dy*dy)), a = Math.atan2(dy, dx);
                        moveVec = { x: Math.cos(a)*(d/45)*0.15, z: Math.sin(a)*(d/45)*0.15 };
                        document.getElementById('joy-stick').style.transform = `translate(${Math.cos(a)*d}px, ${Math.sin(a)*d}px)`;
                    } else if(t.identifier === camId) {
                        players.me.rotation.y -= (t.clientX - lx) * 0.007;
                        camera.rotation.x = Math.max(-1.4, Math.min(1.4, camera.rotation.x - (t.clientY - ly) * 0.007));
                        lx = t.clientX; ly = t.clientY;
                    }
                }
            });
            window.addEventListener('touchend', e => {
                for(let t of e.changedTouches) {
                    if(t.identifier === joyId) { joyId = null; moveVec = {x:0, z:0}; document.getElementById('joy-stick').style.transform = 'none'; }
                    if(t.identifier === camId) camId = null;
                }
            });
        }

        function loop(t) {
            requestAnimationFrame(loop);
            if(t - lastT > 500) { document.getElementById('fps').innerText = Math.round(1000/(t-lastT)*30); lastT = t; }

            if(players.me) {
                // ДИНАМИЧЕСКОЕ НЕБО
                dayTime += 0.002;
                const sY = Math.sin(dayTime);
                sun.position.set(Math.cos(dayTime)*10, sY*10, 5);
                sun.intensity = Math.max(0.1, sY);
                skyColor.setHSL(0.6, 0.5, Math.max(0.1, sY * 0.5 + 0.2));

                // ФИЗИКА
                vY -= 0.012; 
                players.me.position.y += vY;
                
                const bx = Math.round(players.me.position.x), bz = Math.round(players.me.position.z);
                const floorY = Math.floor(players.me.position.y);
                
                if(world.has(`${bx},${floorY},${bz}`)) {
                    if(vY < 0) { 
                        vY = 0; isGrounded = true; 
                        players.me.position.y = floorY + 1; 
                    }
                } else { isGrounded = false; }

                if(players.me.position.y < -10) players.me.position.y = 10;

                const r = players.me.rotation.y;
                const dx = moveVec.x * Math.cos(r) + moveVec.z * Math.sin(r);
                const dz = moveVec.z * Math.cos(r) - moveVec.x * Math.sin(r);
                
                if(!world.has(`${Math.round(players.me.position.x+dx)},${Math.floor(players.me.position.y)},${Math.round(players.me.position.z+dz)}`)) {
                    players.me.position.x += dx; players.me.position.z += dz;
                }

                if(!isFP) {
                    const time = Date.now() * 0.01;
                    const speed = Math.abs(moveVec.x) + Math.abs(moveVec.z);
                    players.me.parts.lL.rotation.x = speed > 0 ? Math.sin(time)*0.5 : 0;
                    players.me.parts.lR.rotation.x = speed > 0 ? -Math.sin(time)*0.5 : 0;
                }

                if(conn && conn.open) conn.send({type:'sync', x:players.me.position.x, y:players.me.position.y, z:players.me.position.z, ry:r});
            }
            renderer.render(scene, camera);
        }
    </script>
</body>
</html>
