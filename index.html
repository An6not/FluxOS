<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>AnnotCraft Full Ultimate</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/0.160.0/three.min.js"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --mc-gui: #c6c6c6; --mc-shadow: #373737; }
        body, html { 
            margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; 
            background: #000; font-family: 'Courier New', monospace; 
            touch-action: none; -webkit-user-select: none; user-select: none;
        }

        /* Кнопки в стиле Minecraft */
        .mc-btn {
            background: #7c7c7c; border: 3px solid #000; color: #fff; padding: 12px;
            margin: 8px 0; width: 100%; font-weight: bold; cursor: pointer;
            box-shadow: inset 3px 3px #fff, inset -3px -3px #333; text-shadow: 2px 2px #000;
            display: block; box-sizing: border-box; text-align: center;
        }
        .mc-btn:active { box-shadow: inset -3px -3px #fff, inset 3px 3px #333; transform: translateY(2px); }

        /* Экраны меню */
        .screen { position: absolute; inset: 0; z-index: 2000; display: flex; align-items: center; justify-content: center; background: rgba(0,0,0,0.8); }
        .panel { background: var(--mc-gui); border: 4px solid #000; padding: 20px; width: 300px; box-shadow: 0 0 20px #000; }
        
        /* Игровой интерфейс (HUD) */
        #ui-hud { position: absolute; inset: 0; pointer-events: none; display: none; z-index: 1000; }
        
        #top-bar { 
            position: absolute; top: 10px; left: 10px; right: 10px; 
            display: flex; gap: 8px; pointer-events: auto; 
        }
        .hud-btn { 
            padding: 8px 12px; background: rgba(0,0,0,0.6); border: 2px solid #fff; 
            color: #fff; font-size: 11px; font-weight: bold; cursor: pointer;
        }

        #hotbar { 
            position: absolute; bottom: 15px; left: 50%; transform: translateX(-50%); 
            display: flex; background: rgba(0,0,0,0.5); padding: 4px; border: 3px solid #111; pointer-events: auto; 
        }
        .slot { width: 46px; height: 46px; border: 2px solid #8b8b8b; margin: 0 2px; position: relative; }
        .slot.active { border: 4px solid #fff; transform: scale(1.1); background: rgba(255,255,255,0.2); }
        .slot canvas { width: 100%; height: 100%; image-rendering: pixelated; }

        /* Джойстик */
        #joy-base { position: absolute; bottom: 40px; left: 40px; width: 110px; height: 110px; border: 4px solid rgba(255,255,255,0.4); border-radius: 50%; pointer-events: auto; }
        #joy-stick { position: absolute; top: 30px; left: 30px; width: 50px; height: 50px; background: #fff; border-radius: 50%; opacity: 0.5; }

        /* Кнопки действий */
        #action-btns { position: absolute; bottom: 40px; right: 25px; display: flex; flex-direction: column; gap: 12px; pointer-events: auto; }
        .circle-btn { 
            width: 70px; height: 70px; border-radius: 50%; background: rgba(0,0,0,0.4); 
            border: 3px solid #fff; color: #fff; display: flex; align-items: center; 
            justify-content: center; font-size: 10px; font-weight: bold; text-shadow: 1px 1px #000;
        }

        #crosshair { position: absolute; top: 50%; left: 50%; width: 16px; height: 16px; border: 2px solid #fff; transform: translate(-50%, -50%); opacity: 0.5; }
        
        input { width: 100%; padding: 10px; margin-bottom: 10px; box-sizing: border-box; background: #444; color: #fff; border: 2px solid #000; }
    </style>
</head>
<body>

    <div id="m-main" class="screen">
        <div class="panel">
            <h1 style="text-align:center; color:#333; margin-top:0;">ANNOT CRAFT</h1>
            <button class="mc-btn" onclick="startFlow('single')">ОДИНОЧНАЯ ИГРА</button>
            <button class="mc-btn" onclick="openMulti()">СЕТЕВАЯ ИГРА</button>
            <div style="font-size: 9px; text-align: center; color: #555;">v14.0 Stable Engine</div>
        </div>
    </div>

    <div id="m-multi" class="screen" style="display:none">
        <div class="panel">
            <h2 style="color:#333;">МУЛЬТИПЛЕЕР</h2>
            <input id="peer-id" type="text" placeholder="ID Комнаты (напр. 777)">
            <button class="mc-btn" onclick="startFlow('host')">СОЗДАТЬ МИР</button>
            <button class="mc-btn" onclick="startFlow('join')">ПОДКЛЮЧИТЬСЯ</button>
            <button class="mc-btn" onclick="backToMain()">НАЗАД</button>
        </div>
    </div>

    <div id="ui-hud">
        <div id="top-bar">
            <div class="hud-btn" onclick="togglePause()">PAUSE</div>
            <div class="hud-btn" onclick="requestFS()">[ FULL ]</div>
            <div class="hud-btn" onclick="forceResize()">FIX SIZE</div>
            <div id="debug-info" style="color:#fff; font-size:10px; margin-left:auto; background:rgba(0,0,0,0.4); padding:4px;">FPS: 60</div>
        </div>

        <div id="crosshair"></div>

        <div id="hotbar">
            <div class="slot active" onclick="changeSlot(0)"><canvas id="ic0"></canvas></div>
            <div class="slot" onclick="changeSlot(1)"><canvas id="ic1"></canvas></div>
            <div class="slot" onclick="changeSlot(2)"><canvas id="ic2"></canvas></div>
            <div class="slot" onclick="changeSlot(3)"><canvas id="ic3"></canvas></div>
            <div class="slot" onclick="changeSlot(4)"><canvas id="ic4"></canvas></div>
        </div>

        <div id="action-btns">
            <div class="circle-btn" style="border-color:#6f6" onpointerdown="triggerAction('place')">PLACE</div>
            <div class="circle-btn" style="border-color:#f66" onpointerdown="triggerAction('break')">BREAK</div>
            <div class="circle-btn" style="width:55px; height:55px; align-self:center;" onpointerdown="doJump()">JUMP</div>
        </div>

        <div id="joy-base"><div id="joy-stick"></div></div>
    </div>

    <div id="m-pause" class="screen" style="display:none">
        <div class="panel">
            <h2 style="color:#333; margin-top:0;">ПАУЗА</h2>
            <button class="mc-btn" onclick="resumeFlow()">ПРОДОЛЖИТЬ</button>
            <button class="mc-btn" onclick="togglePOV()">ВИД: <span id="pov-txt">1-ЛИЦО</span></button>
            <button class="mc-btn" onclick="location.reload()">ВЫЙТИ В МЕНЮ</button>
        </div>
    </div>

    <script>
        /** --- 1. СИСТЕМА ТЕКСТУР --- **/
        function generateBlockTexture(name) {
            const canvas = document.createElement('canvas'); canvas.width = 16; canvas.height = 16;
            const ctx = canvas.getContext('2d');
            const dot = (x, y, c) => { ctx.fillStyle = c; ctx.fillRect(x, y, 1, 1); };

            if(name === 'grass_top') {
                ctx.fillStyle = '#5ba848'; ctx.fillRect(0,0,16,16);
                for(let i=0; i<15; i++) dot(Math.random()*16, Math.random()*16, '#4e913a');
            } else if(name === 'dirt') {
                ctx.fillStyle = '#795548'; ctx.fillRect(0,0,16,16);
                for(let i=0; i<12; i++) dot(Math.random()*16, Math.random()*16, '#5d4037');
            } else if(name === 'grass_side') {
                ctx.fillStyle = '#795548'; ctx.fillRect(0,0,16,16);
                ctx.fillStyle = '#5ba848'; ctx.fillRect(0,0,16,5);
                dot(2,5,'#5ba848'); dot(10,5,'#5ba848'); dot(14,6,'#5ba848');
            } else if(name === 'stone') {
                ctx.fillStyle = '#808080'; ctx.fillRect(0,0,16,16);
                for(let i=0; i<10; i++) dot(Math.random()*16, Math.random()*16, '#999');
            } else if(name === 'wood') {
                ctx.fillStyle = '#6d4c41'; ctx.fillRect(0,0,16,16);
                ctx.fillStyle = '#4e342e'; ctx.fillRect(2,0,2,16); ctx.fillRect(12,0,2,16);
            } else if(name === 'leaves') {
                ctx.fillStyle = '#2e7d32'; ctx.fillRect(0,0,16,16);
                for(let i=0; i<20; i++) dot(Math.random()*16, Math.random()*16, '#1b5e20');
            } else if(name === 'oven') {
                ctx.fillStyle = '#808080'; ctx.fillRect(0,0,16,16);
                ctx.fillStyle = '#000'; ctx.fillRect(3,3,10,5);
                ctx.fillStyle = '#f60'; dot(8,12,'#fff'); dot(7,13,'#ff0');
            }

            const tex = new THREE.CanvasTexture(canvas);
            tex.magFilter = tex.minFilter = THREE.NearestFilter;
            return tex;
        }

        const ASSETS = {
            gt: generateBlockTexture('grass_top'), gs: generateBlockTexture('grass_side'),
            d: generateBlockTexture('dirt'), s: generateBlockTexture('stone'),
            w: generateBlockTexture('wood'), l: generateBlockTexture('leaves'),
            o: generateBlockTexture('oven')
        };

        function getMaterial(id) {
            const m = t => new THREE.MeshLambertMaterial({ map: t });
            if(id === 0) return [m(ASSETS.gs), m(ASSETS.gs), m(ASSETS.gt), m(ASSETS.d), m(ASSETS.gs), m(ASSETS.gs)]; // Трава
            if(id === 1) return m(ASSETS.s); // Камень
            if(id === 2) return m(ASSETS.w); // Дерево
            if(id === 3) return new THREE.MeshLambertMaterial({ map: ASSETS.l, transparent: true, opacity: 0.85 }); // Листва
            if(id === 4) return [m(ASSETS.s), m(ASSETS.s), m(ASSETS.s), m(ASSETS.s), m(ASSETS.o), m(ASSETS.s)]; // Печка
        }

        /** --- 2. ЯДРО ИГРЫ --- **/
        let scene, camera, renderer, world = new Map(), isRunning = false;
        let myPos = new THREE.Vector3(0, 10, 0), vY = 0, myRot = 0, camLat = 0;
        let isFirstPerson = true, currentSlot = 0, hand, steve;
        let joyId, camId, lastX, lastY, moveDir = {x:0, z:0};
        let peer, connection;

        function startFlow(mode) {
            document.querySelectorAll('.screen').forEach(s => s.style.display = 'none');
            document.getElementById('ui-hud').style.display = 'block';
            isRunning = true;
            initWorld();
            if(mode !== 'single') initNetwork(mode);
        }

        function initWorld() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x87ceeb);
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            
            renderer = new THREE.WebGLRenderer({ antialias: false });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            document.body.appendChild(renderer.domElement);

            scene.add(new THREE.AmbientLight(0xffffff, 0.7));
            let sun = new THREE.DirectionalLight(0xffffff, 0.5);
            sun.position.set(10, 50, 10);
            scene.add(sun);

            // Генерация ландшафта (Чанк 16x16)
            for(let x = -10; x <= 10; x++) {
                for(let z = -10; z <= 10; z++) {
                    addBlock(x, 0, z, 0); // Пол
                    if(Math.random() > 0.98) { // Случайные столбы
                        for(let h=1; h<4; h++) addBlock(x, h, z, 2);
                    }
                }
            }

            // Модели
            steve = new THREE.Group();
            let body = new THREE.Mesh(new THREE.BoxGeometry(0.5, 1.7, 0.3), new THREE.MeshLambertMaterial({color: 0x00aaff}));
            steve.add(body); scene.add(steve); steve.visible = false;

            hand = new THREE.Mesh(new THREE.BoxGeometry(0.3, 0.3, 0.6), getMaterial(0));
            camera.add(hand); scene.add(camera);
            hand.position.set(0.4, -0.4, -0.7);

            // Отрисовка иконок
            [ASSETS.gs, ASSETS.s, ASSETS.w, ASSETS.l, ASSETS.o].forEach((t, i) => {
                const ctx = document.getElementById('ic'+i).getContext('2d');
                ctx.imageSmoothingEnabled = false; ctx.drawImage(t.image, 0,0,16,16,0,0,300,150);
            });

            bindControls();
            mainLoop();
        }

        function addBlock(x, y, z, type) {
            const key = `${x},${y},${z}`;
            if(world.has(key)) return;
            const block = new THREE.Mesh(new THREE.BoxGeometry(1, 1, 1), getMaterial(type));
            block.position.set(x, y, z);
            scene.add(block); world.set(key, block);
        }

        /** --- 3. ФИЗИКА КОЛЛИЗИЙ (ФУЛЛ) --- **/
        function isColliding(pos) {
            const r = 0.3; // Радиус игрока
            // Проверяем 4 угла тела на двух уровнях высоты (ноги и голова)
            const checkPoints = [
                {x: pos.x-r, z: pos.z-r}, {x: pos.x+r, z: pos.z-r},
                {x: pos.x-r, z: pos.z+r}, {x: pos.x+r, z: pos.z+r}
            ];
            for(let p of checkPoints) {
                const bx = Math.round(p.x), bz = Math.round(p.z);
                const by1 = Math.floor(pos.y + 0.2); // Ступни
                const by2 = Math.floor(pos.y + 1.6); // Голова
                if(world.has(`${bx},${by1},${bz}`) || world.has(`${bx},${by2},${bz}`)) return true;
            }
            return false;
        }

        /** --- 4. ОСНОВНОЙ ЦИКЛ --- **/
        function mainLoop() {
            requestAnimationFrame(mainLoop);
            if(!isRunning) return;

            // Гравитация
            vY -= 0.015;
            let nextY = myPos.y + vY;
            if(!isColliding({x: myPos.x, y: nextY, z: myPos.z})) {
                myPos.y = nextY;
            } else {
                if(vY < 0) vY = 0;
                myPos.y = Math.floor(myPos.y); 
            }

            // Движение (X и Z отдельно для скольжения по стенам)
            let stepX = moveDir.x * Math.cos(myRot) + moveDir.z * Math.sin(myRot);
            let stepZ = moveDir.z * Math.cos(myRot) - moveDir.x * Math.sin(myRot);

            if(!isColliding({x: myPos.x + stepX, y: myPos.y, z: myPos.z})) myPos.x += stepX;
            if(!isColliding({x: myPos.x, y: myPos.y, z: myPos.z + stepZ})) myPos.z += stepZ;

            // Позиционирование камеры
            if(isFirstPerson) {
                camera.position.set(myPos.x, myPos.y + 1.6, myPos.z);
                camera.rotation.set(camLat, myRot, 0, 'YXZ');
                hand.position.y = -0.4 + Math.sin(Date.now()*0.01)*0.02 * (Math.abs(moveDir.x)*10);
            } else {
                steve.position.copy(myPos); steve.rotation.y = myRot;
                camera.position.set(myPos.x - Math.sin(myRot)*4, myPos.y + 3, myPos.z - Math.cos(myRot)*4);
                camera.lookAt(myPos.x, myPos.y + 1, myPos.z);
            }

            // Сетевой пакет
            if(connection && connection.open && Math.random() > 0.8) {
                connection.send({type:'mv', x:myPos.x, y:myPos.y, z:myPos.z, r:myRot});
            }

            renderer.render(scene, camera);
        }

        /** --- 5. УПРАВЛЕНИЕ --- **/
        function bindControls() {
            window.addEventListener('pointerdown', e => {
                if(e.target.closest('#top-bar') || e.target.closest('#hotbar') || e.target.closest('#action-btns')) return;
                if(e.clientX < window.innerWidth / 2) joyId = e.pointerId;
                else { camId = e.pointerId; lastX = e.clientX; lastY = e.clientY; }
            });
            window.addEventListener('pointermove', e => {
                if(e.pointerId === joyId) {
                    let dx = e.clientX - 95, dy = e.clientY - (window.innerHeight - 95);
                    let d = Math.min(40, Math.sqrt(dx*dx+dy*dy)), a = Math.atan2(dy, dx);
                    moveDir = { x: Math.cos(a)*(d/40)*0.18, z: Math.sin(a)*(d/40)*0.18 };
                    document.getElementById('joy-stick').style.transform = `translate(${Math.cos(a)*d}px, ${Math.sin(a)*d}px)`;
                }
                if(e.pointerId === camId) {
                    myRot -= (e.clientX - lastX) * 0.007;
                    camLat = Math.max(-1.4, Math.min(1.4, camLat - (e.clientY - lastY) * 0.007));
                    lastX = e.clientX; lastY = e.clientY;
                }
            });
            window.addEventListener('pointerup', e => {
                if(e.pointerId === joyId) { joyId = null; moveDir = {x:0, z:0}; document.getElementById('joy-stick').style.transform = 'none'; }
                if(e.pointerId === camId) camId = null;
            });
        }

        function triggerAction(type) {
            hand.position.z = -1.0; setTimeout(()=>hand.position.z=-0.7, 100);
            const ray = new THREE.Raycaster();
            ray.setFromCamera(new THREE.Vector2(0,0), camera);
            const hits = ray.intersectObjects(Array.from(world.values()));
            if(hits.length > 0) {
                const hit = hits[0];
                if(type === 'break' && hit.object.position.y !== 0) {
                    scene.remove(hit.object);
                    world.delete(`${hit.object.position.x},${hit.object.position.y},${hit.object.position.z}`);
                    if(connection) connection.send({type:'br', x:hit.object.position.x, y:hit.object.position.y, z:hit.object.position.z});
                } else if(type === 'place') {
                    const p = hit.point.add(hit.face.normal.multiplyScalar(0.5)).floor();
                    addBlock(p.x, p.y, p.z, currentSlot);
                    if(connection) connection.send({type:'pl', x:p.x, y:p.y, z:p.z, s:currentSlot});
                }
            }
        }

        /** --- 6. ИНТЕРФЕЙС И СЕТЬ --- **/
        function changeSlot(i) { currentSlot = i; document.querySelectorAll('.slot').forEach(s=>s.classList.remove('active')); document.querySelectorAll('.slot')[i].classList.add('active'); hand.material = getMaterial(currentSlot); }
        function doJump() { if(vY === 0) vY = 0.28; }
        function togglePause() { isRunning = false; document.getElementById('m-pause').style.display='flex'; }
        function resumeFlow() { isRunning = true; document.getElementById('m-pause').style.display='none'; }
        function togglePOV() { isFirstPerson = !isFirstPerson; steve.visible = !isFirstPerson; hand.visible = isFirstPerson; document.getElementById('pov-txt').innerText = isFirstPerson?"1-ЛИЦО":"3-ЛИЦО"; }
        function forceResize() { renderer.setSize(window.innerWidth, window.innerHeight); camera.aspect = window.innerWidth/window.innerHeight; camera.updateProjectionMatrix(); }
        function requestFS() { if(!document.fullscreenElement) document.documentElement.requestFullscreen().then(forceResize); else document.exitFullscreen().then(forceResize); }
        function openMulti() { document.getElementById('m-main').style.display='none'; document.getElementById('m-multi').style.display='flex'; }
        function backToMain() { document.getElementById('m-multi').style.display='none'; document.getElementById('m-main').style.display='flex'; }

        function initNetwork(mode) {
            const id = document.getElementById('peer-id').value || 'room99';
            peer = (mode === 'host') ? new Peer('ac_v14_'+id) : new Peer();
            peer.on('open', () => {
                if(mode === 'host') peer.on('connection', c => { connection = c; setupNetEvents(); });
                else { connection = peer.connect('ac_v14_'+id); setupNetEvents(); }
            });
        }

        function setupNetEvents() {
            connection.on('data', d => {
                if(d.type === 'mv') {
                    if(!players.other) { players.other = createSteveModel(0xff0000); scene.add(players.other); }
                    players.other.position.set(d.x, d.y, d.z); players.other.rotation.y = d.r;
                }
                if(d.type === 'pl') addBlock(d.x, d.y, d.z, d.s);
                if(d.type === 'br') {
                    const b = world.get(`${d.x},${d.y},${d.z}`);
                    if(b) { scene.remove(b); world.delete(`${d.x},${d.y},${d.z}`); }
                }
            });
        }
    </script>
</body>
</html>
