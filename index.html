<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>AnnotCraft v16.0: Particles Update</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/0.160.0/three.min.js"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --mc-gui: #c6c6c6; --mc-shadow: #373737; }
        body, html { 
            margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; 
            background: #000; font-family: 'Courier New', monospace; 
            touch-action: none; -webkit-user-select: none;
        }

        /* Кнопки и интерфейс */
        .mc-btn {
            background: #7c7c7c; border: 3px solid #000; color: #fff; padding: 14px;
            margin: 10px 0; width: 100%; font-weight: bold; cursor: pointer;
            box-shadow: inset 4px 4px #fff, inset -4px -4px #333; text-shadow: 2px 2px #000;
            display: block; box-sizing: border-box; text-align: center; font-size: 16px;
        }
        .mc-btn:active { box-shadow: inset -4px -4px #fff, inset 4px 4px #333; transform: translateY(2px); }

        .screen { position: absolute; inset: 0; z-index: 2000; display: flex; align-items: center; justify-content: center; background: rgba(0,0,0,0.85); }
        .panel { background: var(--mc-gui); border: 4px solid #000; padding: 25px; width: 320px; box-shadow: 0 0 30px #000; }
        
        /* HUD */
        #ui-hud { position: absolute; inset: 0; pointer-events: none; display: none; z-index: 1000; }
        #top-bar { position: absolute; top: 15px; left: 15px; right: 15px; display: flex; gap: 10px; pointer-events: auto; }
        .hud-btn { padding: 10px 15px; background: rgba(0,0,0,0.6); border: 2px solid #fff; color: #fff; font-size: 12px; font-weight: bold; cursor: pointer; border-radius: 4px; }

        #hotbar { 
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); 
            display: flex; background: rgba(0,0,0,0.6); padding: 5px; border: 4px solid #111; pointer-events: auto; 
        }
        .slot { width: 50px; height: 50px; border: 2px solid #8b8b8b; margin: 0 3px; background: rgba(255,255,255,0.1); transition: 0.1s; }
        .slot.active { border: 4px solid #fff; transform: scale(1.15); background: rgba(255,255,255,0.3); }
        .slot canvas { width: 100%; height: 100%; image-rendering: pixelated; }

        #joy-base { position: absolute; bottom: 50px; left: 50px; width: 120px; height: 120px; border: 5px solid rgba(255,255,255,0.3); border-radius: 50%; pointer-events: auto; }
        #joy-stick { position: absolute; top: 35px; left: 35px; width: 50px; height: 50px; background: #fff; border-radius: 50%; opacity: 0.6; box-shadow: 0 0 10px #000; }

        #action-btns { position: absolute; bottom: 50px; right: 30px; display: flex; flex-direction: column; gap: 15px; pointer-events: auto; }
        .circle-btn { 
            width: 75px; height: 75px; border-radius: 50%; background: rgba(0,0,0,0.5); 
            border: 3px solid #fff; color: #fff; display: flex; align-items: center; 
            justify-content: center; font-size: 11px; font-weight: bold; text-shadow: 1px 1px #000;
        }

        #crosshair { position: absolute; top: 50%; left: 50%; width: 20px; height: 20px; border: 2px solid #fff; transform: translate(-50%, -50%); opacity: 0.6; }
        input { width: 100%; padding: 12px; margin-bottom: 12px; box-sizing: border-box; background: #333; color: #fff; border: 2px solid #000; font-family: monospace; }
    </style>
</head>
<body>

    <div id="m-main" class="screen">
        <div class="panel">
            <h1 style="text-align:center; color:#333; margin:0 0 20px 0; letter-spacing: 2px;">ANNOT CRAFT</h1>
            <button class="mc-btn" onclick="launch('single')">ОДИНОЧНЫЙ МИР</button>
            <button class="mc-btn" onclick="showScreen('multi')">СЕТЕВАЯ ИГРА</button>
            <button class="mc-btn" onclick="toggleFullScreen()">ЭКРАН [ ]</button>
            <p style="font-size: 10px; color: #666; text-align: center;">BETA v16.0 - PARTICLES & PHYSICS</p>
        </div>
    </div>

    <div id="m-multi" class="screen" style="display:none">
        <div class="panel">
            <h2 style="color:#333; margin-top:0;">СЕТЕВАЯ ИГРА</h2>
            <input id="room-input" type="text" placeholder="ID КОМНАТЫ">
            <button class="mc-btn" onclick="launch('host')">СОЗДАТЬ СЕРВЕР</button>
            <button class="mc-btn" onclick="launch('join')">ПРИСОЕДИНИТЬСЯ</button>
            <button class="mc-btn" onclick="showScreen('main')">НАЗАД</button>
        </div>
    </div>

    <div id="ui-hud">
        <div id="top-bar">
            <div class="hud-btn" onclick="pauseGame(true)">PAUSE</div>
            <div class="hud-btn" onclick="restyleUI()">FIX UI</div>
            <div id="stats" style="color:#fff; font-size:10px; margin-left:auto; background:rgba(0,0,0,0.5); padding:5px;">FPS: 60 | POS: 0,0,0</div>
        </div>
        <div id="crosshair"></div>
        <div id="hotbar">
            <div class="slot active" onclick="setSlot(0)"><canvas id="ic0"></canvas></div>
            <div class="slot" onclick="setSlot(1)"><canvas id="ic1"></canvas></div>
            <div class="slot" onclick="setSlot(2)"><canvas id="ic2"></canvas></div>
            <div class="slot" onclick="setSlot(3)"><canvas id="ic3"></canvas></div>
            <div class="slot" onclick="setSlot(4)"><canvas id="ic4"></canvas></div>
        </div>
        <div id="action-btns">
            <div class="circle-btn" style="border-color:#4f4;" onpointerdown="handleInteraction('place')">PLACE</div>
            <div class="circle-btn" style="border-color:#f44;" onpointerdown="handleInteraction('break')">BREAK</div>
            <div class="circle-btn" style="width:60px; height:60px; align-self:center;" onpointerdown="jump()">JUMP</div>
        </div>
        <div id="joy-base"><div id="joy-stick"></div></div>
    </div>

    <div id="m-pause" class="screen" style="display:none">
        <div class="panel">
            <h2 style="color:#333; margin:0 0 20px 0;">ПАУЗА</h2>
            <button class="mc-btn" onclick="pauseGame(false)">ПРОДОЛЖИТЬ</button>
            <button class="mc-btn" onclick="togglePOV()">ВИД: <span id="pov-label">1-ЛИЦО</span></button>
            <button class="mc-btn" onclick="location.reload()">В МЕНЮ</button>
        </div>
    </div>

    <script>
        /** --- 1. ГЕНЕРАЦИЯ РЕСУРСОВ --- **/
        function createMCTexture(type) {
            const c = document.createElement('canvas'); c.width = 16; c.height = 16;
            const x = c.getContext('2d');
            const pix = (px, py, cl) => { x.fillStyle = cl; x.fillRect(px, py, 1, 1); };

            if(type === 'grass_t') {
                x.fillStyle = '#5ba848'; x.fillRect(0,0,16,16);
                for(let i=0; i<15; i++) pix(Math.random()*16, Math.random()*16, '#4e913a');
            } else if(type === 'grass_s') {
                x.fillStyle = '#795548'; x.fillRect(0,0,16,16);
                x.fillStyle = '#5ba848'; x.fillRect(0,0,16,5);
                pix(1,5,'#5ba848'); pix(10,5,'#5ba848');
            } else if(type === 'dirt') {
                x.fillStyle = '#795548'; x.fillRect(0,0,16,16);
                for(let i=0; i<10; i++) pix(Math.random()*16, Math.random()*16, '#5d4037');
            } else if(type === 'stone') {
                x.fillStyle = '#808080'; x.fillRect(0,0,16,16);
                for(let i=0; i<10; i++) pix(Math.random()*16, Math.random()*16, '#666');
            } else if(type === 'wood') {
                x.fillStyle = '#6d4c41'; x.fillRect(0,0,16,16);
                x.fillStyle = '#4e342e'; x.fillRect(2,0,2,16); x.fillRect(12,0,2,16);
            } else if(type === 'leaves') {
                x.fillStyle = '#2e7d32'; x.fillRect(0,0,16,16);
                for(let i=0; i<20; i++) pix(Math.random()*16, Math.random()*16, '#1b5e20');
            } else if(type === 'oven') {
                x.fillStyle = '#808080'; x.fillRect(0,0,16,16);
                x.fillStyle = '#222'; x.fillRect(3,3,10,5); pix(8,12,'#f60');
            }

            const t = new THREE.CanvasTexture(c);
            t.magFilter = t.minFilter = THREE.NearestFilter;
            return t;
        }

        const TEXTURES = {
            gt: createMCTexture('grass_t'), gs: createMCTexture('grass_s'), 
            d: createMCTexture('dirt'), s: createMCTexture('stone'), 
            w: createMCTexture('wood'), l: createMCTexture('leaves'), o: createMCTexture('oven')
        };

        function getBlockMaterial(id) {
            const m = t => new THREE.MeshLambertMaterial({ map: t });
            if(id === 0) return [m(TEXTURES.gs), m(TEXTURES.gs), m(TEXTURES.gt), m(TEXTURES.d), m(TEXTURES.gs), m(TEXTURES.gs)];
            if(id === 1) return m(TEXTURES.s);
            if(id === 2) return m(TEXTURES.w);
            if(id === 3) return new THREE.MeshLambertMaterial({ map: TEXTURES.l, transparent: true, opacity: 0.85 });
            if(id === 4) return [m(TEXTURES.s), m(TEXTURES.s), m(TEXTURES.s), m(TEXTURES.s), m(TEXTURES.o), m(TEXTURES.s)];
        }

        /** --- 2. ЯДРО --- **/
        let scene, camera, renderer, world = new Map(), particles = [];
        let isGameActive = false, isFP = true, activeSlot = 0;
        let playerPos = new THREE.Vector3(0, 5, 0), velocityY = 0, playerRot = 0, pitch = 0;
        let handMesh, steveMesh, otherPlayers = {};
        let joyState = { x: 0, z: 0 }, touchData = { joyId: null, camId: null, lx: 0, ly: 0 };
        let peer, connection;

        function launch(mode) {
            document.querySelectorAll('.screen').forEach(s => s.style.display = 'none');
            document.getElementById('ui-hud').style.display = 'block';
            isGameActive = true;
            initEngine();
            if(mode !== 'single') initNet(mode);
        }

        function initEngine() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x87ceeb);
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            
            renderer = new THREE.WebGLRenderer({ antialias: false });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            document.body.appendChild(renderer.domElement);

            scene.add(new THREE.AmbientLight(0xffffff, 0.7));
            let sun = new THREE.DirectionalLight(0xffffff, 0.6);
            sun.position.set(20, 50, 10);
            scene.add(sun);

            // Генерация начального мира
            for(let x = -12; x <= 12; x++) {
                for(let z = -12; z <= 12; z++) {
                    spawnBlock(x, 0, z, 0); // Трава
                    if(Math.random() > 0.98) { // Деревья
                        for(let h=1; h<5; h++) spawnBlock(x, h, z, 2);
                        for(let lx=-1; lx<=1; lx++) 
                            for(let lz=-1; lz<=1; lz++) spawnBlock(x+lx, 5, z+lz, 3);
                    }
                }
            }

            // Модели игрока
            steveMesh = new THREE.Group();
            let body = new THREE.Mesh(new THREE.BoxGeometry(0.5, 1.7, 0.3), new THREE.MeshLambertMaterial({color: 0x00aaff}));
            steveMesh.add(body); scene.add(steveMesh); steveMesh.visible = false;

            handMesh = new THREE.Mesh(new THREE.BoxGeometry(0.3, 0.3, 0.6), getBlockMaterial(0));
            camera.add(handMesh); scene.add(camera);
            handMesh.position.set(0.5, -0.5, -0.8);

            // Иконки в инвентаре
            [TEXTURES.gs, TEXTURES.s, TEXTURES.w, TEXTURES.l, TEXTURES.o].forEach((t, i) => {
                const ctx = document.getElementById('ic'+i).getContext('2d');
                ctx.imageSmoothingEnabled = false; ctx.drawImage(t.image, 0,0,16,16,0,0,300,150);
            });

            setupControls();
            gameLoop();
        }

        function spawnBlock(x, y, z, type) {
            const key = `${x},${y},${z}`;
            if(world.has(key)) return;
            const b = new THREE.Mesh(new THREE.BoxGeometry(1, 1, 1), getBlockMaterial(type));
            b.position.set(x, y, z);
            b.blockType = type;
            scene.add(b); world.set(key, b);
        }

        /** --- 3. СИСТЕМА ЧАСТИЦ --- **/
        function burstParticles(pos, type) {
            const count = 12;
            const mat = new THREE.MeshLambertMaterial({ color: getParticleColor(type) });
            const geom = new THREE.BoxGeometry(0.15, 0.15, 0.15);

            for(let i=0; i<count; i++) {
                const p = new THREE.Mesh(geom, mat);
                p.position.copy(pos);
                p.velocity = new THREE.Vector3(
                    (Math.random()-0.5)*0.2,
                    Math.random()*0.2,
                    (Math.random()-0.5)*0.2
                );
                p.life = 1.0;
                scene.add(p);
                particles.push(p);
            }
        }

        function getParticleColor(type) {
            if(type === 0) return 0x5ba848;
            if(type === 1) return 0x808080;
            if(type === 2) return 0x6d4c41;
            if(type === 3) return 0x2e7d32;
            return 0xffffff;
        }

        /** --- 4. ФИЗИКА И ЦИКЛ --- **/
        function checkCollision(pos) {
            const r = 0.3;
            const checks = [
                {x: pos.x-r, z: pos.z-r}, {x: pos.x+r, z: pos.z-r},
                {x: pos.x-r, z: pos.z+r}, {x: pos.x+r, z: pos.z+r}
            ];
            for(let c of checks) {
                const bx = Math.round(c.x), bz = Math.round(c.z);
                if(world.has(`${bx},${Math.floor(pos.y+0.1)},${bz}`) || 
                   world.has(`${bx},${Math.floor(pos.y+1.6)},${bz}`)) return true;
            }
            return false;
        }

        function gameLoop() {
            requestAnimationFrame(gameLoop);
            if(!isGameActive) return;

            // Гравитация
            velocityY -= 0.016;
            let nextY = playerPos.y + velocityY;
            if(!checkCollision({x: playerPos.x, y: nextY, z: playerPos.z})) {
                playerPos.y = nextY;
            } else {
                if(velocityY < 0) velocityY = 0;
                playerPos.y = Math.floor(playerPos.y + 0.1); 
            }

            // Движение
            let dx = joyState.x * Math.cos(playerRot) + joyState.z * Math.sin(playerRot);
            let dz = joyState.z * Math.cos(playerRot) - joyState.x * Math.sin(playerRot);
            if(!checkCollision({x: playerPos.x + dx, y: playerPos.y, z: playerPos.z})) playerPos.x += dx;
            if(!checkCollision({x: playerPos.x, y: playerPos.y, z: playerPos.z + dz})) playerPos.z += dz;

            // Частицы
            for(let i = particles.length-1; i >= 0; i--) {
                const p = particles[i];
                p.position.add(p.velocity);
                p.velocity.y -= 0.01;
                p.life -= 0.02;
                p.scale.setScalar(p.life);
                if(p.life <= 0) {
                    scene.remove(p);
                    particles.splice(i, 1);
                }
            }

            // Камера и рука
            if(isFP) {
                camera.position.set(playerPos.x, playerPos.y + 1.6, playerPos.z);
                camera.rotation.set(pitch, playerRot, 0, 'YXZ');
                // Анимация покачивания
                const swing = Math.sin(Date.now()*0.008) * 0.02 * (Math.abs(joyState.x)*10 + Math.abs(joyState.z)*10);
                handMesh.position.y = -0.5 + swing;
                handMesh.position.z = -0.8 + Math.abs(swing);
            } else {
                steveMesh.position.copy(playerPos); steveMesh.rotation.y = playerRot;
                camera.position.set(playerPos.x - Math.sin(playerRot)*4, playerPos.y + 3, playerPos.z - Math.cos(playerRot)*4);
                camera.lookAt(playerPos.x, playerPos.y + 1, playerPos.z);
            }

            // UI
            document.getElementById('stats').innerText = `FPS: 60 | POS: ${Math.round(playerPos.x)}, ${Math.round(playerPos.y)}, ${Math.round(playerPos.z)}`;

            if(connection && connection.open && Math.random() > 0.8) {
                connection.send({type:'m', x:playerPos.x, y:playerPos.y, z:playerPos.z, r:playerRot});
            }

            renderer.render(scene, camera);
        }

        /** --- 5. ВЗАИМОДЕЙСТВИЕ --- **/
        function handleInteraction(type) {
            // Визуальный эффект удара рукой
            handMesh.rotation.x = -0.5;
            setTimeout(() => handMesh.rotation.x = 0, 100);

            const ray = new THREE.Raycaster();
            ray.setFromCamera(new THREE.Vector2(0,0), camera);
            const hits = ray.intersectObjects(Array.from(world.values()));

            if(hits.length > 0) {
                const h = hits[0];
                const p = h.object.position;
                if(type === 'break' && p.y !== 0) {
                    burstParticles(p, h.object.blockType);
                    scene.remove(h.object);
                    world.delete(`${p.x},${p.y},${p.z}`);
                    if(connection) connection.send({type:'b', x:p.x, y:p.y, z:p.z});
                } else if(type === 'place') {
                    const np = h.point.add(h.face.normal.multiplyScalar(0.5)).floor();
                    spawnBlock(np.x, np.y, np.z, activeSlot);
                    if(connection) connection.send({type:'p', x:np.x, y:np.y, z:np.z, s:activeSlot});
                }
            }
        }

        function setupControls() {
            window.addEventListener('pointerdown', e => {
                if(e.target.closest('#top-bar') || e.target.closest('#hotbar') || e.target.closest('#action-btns')) return;
                if(e.clientX < window.innerWidth/2) touchData.joyId = e.pointerId;
                else { touchData.camId = e.pointerId; touchData.lx = e.clientX; touchData.ly = e.clientY; }
            });

            window.addEventListener('pointermove', e => {
                if(e.pointerId === touchData.joyId) {
                    let dx = e.clientX - 110, dy = e.clientY - (window.innerHeight - 110);
                    let d = Math.min(45, Math.sqrt(dx*dx+dy*dy)), a = Math.atan2(dy, dx);
                    joyState = { x: Math.cos(a)*(d/45)*0.18, z: Math.sin(a)*(d/45)*0.18 };
                    document.getElementById('joy-stick').style.transform = `translate(${Math.cos(a)*d}px, ${Math.sin(a)*d}px)`;
                }
                if(e.pointerId === touchData.camId) {
                    playerRot -= (e.clientX - touchData.lx) * 0.007;
                    pitch = Math.max(-1.5, Math.min(1.5, pitch - (e.clientY - touchData.ly) * 0.007));
                    touchData.lx = e.clientX; touchData.ly = e.clientY;
                }
            });

            window.addEventListener('pointerup', e => {
                if(e.pointerId === touchData.joyId) { touchData.joyId = null; joyState = {x:0, z:0}; document.getElementById('joy-stick').style.transform = 'none'; }
                if(e.pointerId === touchData.camId) touchData.camId = null;
            });
        }

        /** --- 6. ДОПОЛНИТЕЛЬНО --- **/
        function setSlot(i) { activeSlot = i; document.querySelectorAll('.slot').forEach(s => s.classList.remove('active')); document.querySelectorAll('.slot')[i].classList.add('active'); handMesh.material = getBlockMaterial(activeSlot); }
        function jump() { if(velocityY === 0) velocityY = 0.28; }
        function pauseGame(v) { isGameActive = !v; document.getElementById('m-pause').style.display = v?'flex':'none'; }
        function showScreen(id) { document.querySelectorAll('.screen').forEach(s => s.style.display='none'); document.getElementById('m-'+id).style.display='flex'; }
        function togglePOV() { isFP = !isFP; steveMesh.visible = !isFP; handMesh.visible = isFP; document.getElementById('pov-label').innerText = isFP?"1-ЛИЦО":"3-ЛИЦО"; }
        function toggleFullScreen() { if(!document.fullscreenElement) document.documentElement.requestFullscreen(); else document.exitFullscreen(); }
        function restyleUI() { renderer.setSize(window.innerWidth, window.innerHeight); camera.aspect = window.innerWidth/window.innerHeight; camera.updateProjectionMatrix(); }

        function initNet(mode) {
            const id = document.getElementById('room-input').value || 'room777';
            peer = (mode === 'host') ? new Peer('ac_v16_'+id) : new Peer();
            peer.on('open', () => {
                if(mode === 'host') peer.on('connection', c => { connection = c; setupNetHandlers(); });
                else { connection = peer.connect('ac_v16_'+id); setupNetHandlers(); }
            });
        }

        function setupNetHandlers() {
            connection.on('data', d => {
                if(d.type === 'm') {
                    if(!otherPlayers.p1) {
                        otherPlayers.p1 = new THREE.Group();
                        otherPlayers.p1.add(new THREE.Mesh(new THREE.BoxGeometry(0.5, 1.7, 0.3), new THREE.MeshLambertMaterial({color: 0xff0000})));
                        scene.add(otherPlayers.p1);
                    }
                    otherPlayers.p1.position.set(d.x, d.y, d.z); otherPlayers.p1.rotation.y = d.r;
                }
                if(d.type === 'p') spawnBlock(d.x, d.y, d.z, d.s);
                if(d.type === 'b') {
                    const b = world.get(`${d.x},${d.y},${d.z}`);
                    if(b) { scene.remove(b); world.delete(`${d.x},${d.y},${d.z}`); }
                }
            });
        }
    </script>
</body>
</html>
