<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>AnnotCraft Ultimate v12</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/0.160.0/three.min.js"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --mc-gui: #c6c6c6; --mc-border: #000; --mc-sel: #ffffff; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: #000; font-family: 'Courier New', monospace; touch-action: none; -webkit-user-select: none; }

        /* UI ИНТЕРФЕЙС */
        .mc-btn {
            background: #7c7c7c; border: 3px solid #000; color: #fff; padding: 12px;
            margin: 8px 0; width: 100%; font-weight: bold; cursor: pointer;
            box-shadow: inset 3px 3px #fff, inset -3px -3px #333; text-shadow: 2px 2px #000;
            display: block; box-sizing: border-box; text-align: center;
        }
        .mc-btn:active { box-shadow: inset -3px -3px #fff, inset 3px 3px #333; transform: translateY(2px); }

        .screen { position: absolute; inset: 0; z-index: 2000; display: flex; align-items: center; justify-content: center; background: rgba(0,0,0,0.7); }
        .panel { background: var(--mc-gui); border: 4px solid #000; padding: 20px; width: 300px; box-shadow: 0 0 20px #000; }
        
        /* HUD И ИГРА */
        #ui-hud { position: absolute; inset: 0; pointer-events: none; display: none; z-index: 1000; }
        #crosshair { position: absolute; top: 50%; left: 50%; width: 18px; height: 18px; transform: translate(-50%, -50%); border: 2px solid #fff; opacity: 0.6; }
        
        #hotbar { position: absolute; bottom: 15px; left: 50%; transform: translateX(-50%); display: flex; background: rgba(0,0,0,0.5); padding: 4px; border: 3px solid #111; pointer-events: auto; }
        .slot { width: 46px; height: 46px; border: 2px solid #8b8b8b; margin: 0 2px; position: relative; }
        .slot.active { border: 4px solid #fff; transform: scale(1.1); background: rgba(255,255,255,0.2); }
        .slot canvas { width: 100%; height: 100%; image-rendering: pixelated; }

        #joy-base { position: absolute; bottom: 40px; left: 40px; width: 110px; height: 110px; border: 4px solid rgba(255,255,255,0.4); border-radius: 50%; pointer-events: auto; }
        #joy-stick { position: absolute; top: 30px; left: 30px; width: 50px; height: 50px; background: #fff; border-radius: 50%; opacity: 0.5; }

        #controls { position: absolute; bottom: 40px; right: 25px; display: flex; flex-direction: column; gap: 12px; pointer-events: auto; }
        .circle-btn { width: 68px; height: 68px; border-radius: 50%; background: rgba(0,0,0,0.4); border: 3px solid #fff; color: #fff; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: bold; }

        #top-bar { position: absolute; top: 10px; left: 10px; right: 10px; display: flex; justify-content: space-between; pointer-events: auto; }
        .pause-btn { width: 44px; height: 44px; background: #7c7c7c; border: 3px solid #000; color: #fff; font-weight: bold; display: flex; align-items: center; justify-content: center; }
        
        input { width: 100%; padding: 10px; margin-bottom: 10px; box-sizing: border-box; background: #444; color: #fff; border: 2px solid #000; }
    </style>
</head>
<body>

    <div id="m-main" class="screen">
        <div class="panel">
            <h1 style="text-align:center; color:#333; margin-top:0;">ANNOT CRAFT</h1>
            <button class="mc-btn" onclick="startMode('single')">ОДИНОЧНАЯ</button>
            <button class="mc-btn" onclick="toggleMenu('multi')">СЕТЕВАЯ</button>
            <button class="mc-btn" onclick="toggleFS()">ЭКРАН [ ]</button>
        </div>
    </div>

    <div id="m-multi" class="screen" style="display:none">
        <div class="panel">
            <h2 style="color:#333;">СЕТЕВАЯ ИГРА</h2>
            <input id="srv-id" type="text" placeholder="ID Комнаты (напр. 1234)">
            <button class="mc-btn" onclick="startMode('host')">СОЗДАТЬ</button>
            <button class="mc-btn" onclick="startMode('join')">ВОЙТИ</button>
            <button class="mc-btn" onclick="toggleMenu('main')">НАЗАД</button>
        </div>
    </div>

    <div id="m-pause" class="screen" style="display:none">
        <div class="panel">
            <h2 style="color:#333; margin-top:0;">ПАУЗА</h2>
            <button class="mc-btn" onclick="resumeGame()">ПРОДОЛЖИТЬ</button>
            <button class="mc-btn" onclick="toggleCam()">ВИД: <span id="v-txt">1 ЛИЦО</span></button>
            <button class="mc-btn" onclick="location.reload()">ВЫЙТИ</button>
        </div>
    </div>

    <div id="ui-hud">
        <div id="top-bar">
            <div class="pause-btn" onclick="pauseGame()">||</div>
            <div style="color:#fff; text-shadow:2px 2px #000;">AnnotCraft v12.0</div>
        </div>
        <div id="crosshair"></div>
        <div id="hotbar">
            <div class="slot active" onclick="setSlot(0)"><canvas id="ic0"></canvas></div>
            <div class="slot" onclick="setSlot(1)"><canvas id="ic1"></canvas></div>
            <div class="slot" onclick="setSlot(2)"><canvas id="ic2"></canvas></div>
            <div class="slot" onclick="setSlot(3)"><canvas id="ic3"></canvas></div>
            <div class="slot" onclick="setSlot(4)"><canvas id="ic4"></canvas></div>
        </div>
        <div id="controls">
            <div class="circle-btn" style="border-color:#6f6" onpointerdown="useBlock('place')">PLACE</div>
            <div class="circle-btn" style="border-color:#f66" onpointerdown="useBlock('break')">BREAK</div>
            <div class="circle-btn" style="width:50px; height:50px; align-self:center;" onpointerdown="doJump()">JUMP</div>
        </div>
        <div id="joy-base"><div id="joy-stick"></div></div>
    </div>

    <script>
        /** --- 1. ГЕНЕРАТОР ТЕКСТУР (ПИКСЕЛЬ-АРТ) --- **/
        function genTexture(type) {
            const c = document.createElement('canvas'); c.width = 16; c.height = 16;
            const x = c.getContext('2d');
            const draw = (px, py, cl) => { x.fillStyle = cl; x.fillRect(px,py,1,1); };

            if(type === 'grass_top') {
                x.fillStyle = '#5ba848'; x.fillRect(0,0,16,16);
                for(let i=0; i<12; i++) draw(Math.random()*16, Math.random()*16, '#4e913a');
            } else if(type === 'dirt') {
                x.fillStyle = '#795548'; x.fillRect(0,0,16,16);
                for(let i=0; i<10; i++) draw(Math.random()*16, Math.random()*16, '#5d4037');
            } else if(type === 'grass_side') {
                x.fillStyle = '#795548'; x.fillRect(0,0,16,16);
                x.fillStyle = '#5ba848'; x.fillRect(0,0,16,5);
                draw(2,5,'#5ba848'); draw(8,6,'#5ba848'); draw(13,5,'#5ba848');
            } else if(type === 'stone') {
                x.fillStyle = '#808080'; x.fillRect(0,0,16,16);
                for(let i=0; i<8; i++) draw(Math.random()*16, Math.random()*16, '#999');
            } else if(type === 'wood_side') {
                x.fillStyle = '#6d4c41'; x.fillRect(0,0,16,16);
                x.fillStyle = '#4e342e'; x.fillRect(2,0,2,16); x.fillRect(12,0,2,16);
            } else if(type === 'wood_top') {
                x.fillStyle = '#d3b38c'; x.fillRect(0,0,16,16);
                x.strokeStyle = '#6d4c41'; x.strokeRect(3,3,10,10); x.strokeRect(6,6,4,4);
            } else if(type === 'leaves') {
                x.fillStyle = '#2e7d32'; x.fillRect(0,0,16,16);
                for(let i=0; i<20; i++) draw(Math.random()*16, Math.random()*16, '#1b5e20');
            } else if(type === 'oven') {
                x.fillStyle = '#808080'; x.fillRect(0,0,16,16);
                x.fillStyle = '#000'; x.fillRect(3,3,10,5); // Слот
                x.fillStyle = '#ff6600'; draw(8,12,'#fff'); draw(7,13,'#ff0'); // Огонь
            }
            
            const t = new THREE.CanvasTexture(c);
            t.magFilter = t.minFilter = THREE.NearestFilter;
            return t;
        }

        const TEX = {
            gt: genTexture('grass_top'), gs: genTexture('grass_side'), d: genTexture('dirt'),
            s: genTexture('stone'), ws: genTexture('wood_side'), wt: genTexture('wood_top'),
            l: genTexture('leaves'), o: genTexture('oven')
        };

        function getBlockMat(id) {
            const m = t => new THREE.MeshLambertMaterial({ map: t });
            if(id === 0) return [m(TEX.gs), m(TEX.gs), m(TEX.gt), m(TEX.d), m(TEX.gs), m(TEX.gs)]; // Трава
            if(id === 1) return m(TEX.s); // Камень
            if(id === 2) return [m(TEX.ws), m(TEX.ws), m(TEX.wt), m(TEX.wt), m(TEX.ws), m(TEX.ws)]; // Дерево
            if(id === 3) return new THREE.MeshLambertMaterial({ map: TEX.l, transparent: true, opacity: 0.85 }); // Листва
            if(id === 4) return [m(TEX.s), m(TEX.s), m(TEX.s), m(TEX.s), m(TEX.o), m(TEX.s)]; // Печка
        }

        /** --- 2. ГЛОБАЛЬНЫЕ ПЕРЕМЕННЫЕ --- **/
        let scene, camera, renderer, sun, clock = new THREE.Clock();
        let world = new Map(), players = {}, hand, steve;
        let isGame = false, isFP = true, slot = 0;
        let myPos = new THREE.Vector3(0, 5, 0), vY = 0, myRot = 0, camLat = 0;
        let joyId, camId, lx, ly, mov = {x:0, z:0};
        let peer, conn;

        /** --- 3. ИНИЦИАЛИЗАЦИЯ --- **/
        window.onload = () => {
            // Рисуем иконки в инвентаре
            [TEX.gs, TEX.s, TEX.ws, TEX.l, TEX.o].forEach((t, i) => {
                const ctx = document.getElementById('ic'+i).getContext('2d');
                ctx.imageSmoothingEnabled = false;
                ctx.drawImage(t.image, 0, 0, 16, 16, 0, 0, 300, 150);
            });
        };

        function startMode(mode) {
            document.querySelectorAll('.screen').forEach(s => s.style.display = 'none');
            document.getElementById('ui-hud').style.display = 'block';
            isGame = true;
            initEngine();
            if(mode !== 'single') initNet(mode);
        }

        function initEngine() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x87ceeb);
            camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
            
            renderer = new THREE.WebGLRenderer({ antialias: false });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            document.body.appendChild(renderer.domElement);

            scene.add(new THREE.AmbientLight(0xffffff, 0.7));
            sun = new THREE.DirectionalLight(0xffffff, 0.6);
            sun.position.set(10, 20, 10);
            scene.add(sun);

            // Генерация стартового пола
            for(let x=-10; x<=10; x++) {
                for(let z=-10; z<=10; z++) {
                    createBlock(x, 0, z, 0);
                }
            }

            // Создание моделей
            steve = createSteveModel(0x00ff00);
            scene.add(steve); steve.visible = false;

            hand = new THREE.Mesh(new THREE.BoxGeometry(0.3, 0.3, 0.3), getBlockMat(0));
            camera.add(hand); scene.add(camera);
            hand.position.set(0.4, -0.4, -0.6);

            setupControls();
            loop();
        }

        function createSteveModel(color) {
            const g = new THREE.Group();
            const m = new THREE.MeshLambertMaterial({color: color});
            const head = new THREE.Mesh(new THREE.BoxGeometry(0.4, 0.4, 0.4), m); head.position.y = 1.6;
            const body = new THREE.Mesh(new THREE.BoxGeometry(0.4, 0.6, 0.2), new THREE.MeshLambertMaterial({color:0x00aaff})); body.position.y = 1.1;
            const l1 = new THREE.Mesh(new THREE.BoxGeometry(0.18, 0.7, 0.18), new THREE.MeshLambertMaterial({color:0x000088})); l1.position.set(-0.1, 0.4, 0);
            const l2 = l1.clone(); l2.position.x = 0.1;
            g.add(head, body, l1, l2);
            g.legs = [l1, l2];
            return g;
        }

        function createBlock(x,y,z,t) {
            const k = `${x},${y},${z}`;
            if(world.has(k)) return;
            const b = new THREE.Mesh(new THREE.BoxGeometry(1,1,1), getBlockMat(t));
            b.position.set(x,y,z);
            scene.add(b); world.set(k, b);
        }

        /** --- 4. УПРАВЛЕНИЕ И ЦИКЛ --- **/
        function setupControls() {
            window.addEventListener('pointerdown', e => {
                if(e.target.closest('#hotbar') || e.target.closest('.pause-btn') || e.target.closest('#controls')) return;
                if(e.clientX < window.innerWidth/2) joyId = e.pointerId;
                else { camId = e.pointerId; lx = e.clientX; ly = e.clientY; }
            });

            window.addEventListener('pointermove', e => {
                if(e.pointerId === joyId) {
                    let dx = e.clientX - 95, dy = e.clientY - (window.innerHeight - 95);
                    let d = Math.min(40, Math.sqrt(dx*dx+dy*dy)), a = Math.atan2(dy, dx);
                    mov = { x: Math.cos(a)*(d/40)*0.15, z: Math.sin(a)*(d/40)*0.15 };
                    document.getElementById('joy-stick').style.transform = `translate(${Math.cos(a)*d}px, ${Math.sin(a)*d}px)`;
                }
                if(e.pointerId === camId) {
                    myRot -= (e.clientX - lx) * 0.006;
                    camLat = Math.max(-1.4, Math.min(1.4, camLat - (e.clientY - ly) * 0.006));
                    lx = e.clientX; ly = e.clientY;
                }
            });

            window.addEventListener('pointerup', e => {
                if(e.pointerId === joyId) { joyId = null; mov = {x:0, z:0}; document.getElementById('joy-stick').style.transform = 'none'; }
                if(e.pointerId === camId) camId = null;
            });
        }

        function loop() {
            requestAnimationFrame(loop);
            if(!isGame) return;

            // День / Ночь
            const time = Date.now() * 0.0005;
            sun.position.set(Math.sin(time)*20, Math.cos(time)*20, 10);
            scene.background.setHSL(0.6, 0.5, Math.max(0.1, Math.cos(time)*0.5+0.5));

            // Физика
            vY -= 0.013; myPos.y += vY;
            let cx = Math.round(myPos.x), cz = Math.round(myPos.z), cy = Math.floor(myPos.y);
            if(world.has(`${cx},${cy},${cz}`)) { myPos.y = cy + 1; vY = 0; }
            if(myPos.y < -10) myPos.y = 10;

            // Движение
            myPos.x += mov.x * Math.cos(myRot) + mov.z * Math.sin(myRot);
            myPos.z += mov.z * Math.cos(myRot) - mov.x * Math.sin(myRot);

            // Рендер Камеры
            if(isFP) {
                camera.position.set(myPos.x, myPos.y + 1.6, myPos.z);
                camera.rotation.set(camLat, myRot, 0, 'YXZ');
                // Анимация ходьбы для руки
                hand.position.y = -0.4 + Math.sin(Date.now()*0.01)*0.02 * (Math.abs(mov.x)*10);
            } else {
                steve.position.copy(myPos); steve.rotation.y = myRot;
                let ox = Math.sin(myRot)*4, oz = Math.cos(myRot)*4;
                camera.position.set(myPos.x - ox, myPos.y + 3, myPos.z - oz);
                camera.lookAt(myPos.x, myPos.y + 1, myPos.z);
                // Анимация ног Стива
                const s = Math.sin(Date.now()*0.01) * 0.5;
                steve.legs[0].rotation.x = s; steve.legs[1].rotation.x = -s;
            }

            // Синхронизация по сети
            if(conn && conn.open && Math.random() > 0.8) {
                conn.send({t:'mv', x:myPos.x, y:myPos.y, z:myPos.z, r:myRot});
            }

            renderer.render(scene, camera);
        }

        /** --- 5. ДЕЙСТВИЯ --- **/
        function useBlock(type) {
            if(!isGame) return;
            // Анимация удара
            hand.position.z = -0.8; setTimeout(()=>hand.position.z=-0.6, 100);

            const ray = new THREE.Raycaster();
            ray.setFromCamera(new THREE.Vector2(0,0), camera);
            const hits = ray.intersectObjects(Array.from(world.values()));
            
            if(hits.length > 0) {
                const h = hits[0];
                if(type === 'break' && h.object.position.y !== 0) {
                    scene.remove(h.object);
                    world.delete(`${h.object.position.x},${h.object.position.y},${h.object.position.z}`);
                    if(conn) conn.send({t:'br', x:h.object.position.x, y:h.object.position.y, z:h.object.position.z});
                } else if(type === 'place') {
                    const p = h.point.add(h.face.normal.multiplyScalar(0.5)).floor();
                    createBlock(p.x, p.y, p.z, slot);
                    if(conn) conn.send({t:'pl', x:p.x, y:p.y, z:p.z, s:slot});
                }
            }
        }

        function setSlot(i) {
            slot = i;
            document.querySelectorAll('.slot').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.slot')[i].classList.add('active');
            hand.material = getBlockMat(slot);
        }

        function doJump() { if(vY === 0) vY = 0.26; }
        function pauseGame() { isGame = false; document.getElementById('m-pause').style.display='flex'; }
        function resumeGame() { isGame = true; document.getElementById('m-pause').style.display='none'; }
        function toggleCam() { isFP = !isFP; steve.visible = !isFP; hand.visible = isFP; document.getElementById('v-txt').innerText = isFP ? "1 ЛИЦО" : "3 ЛИЦО"; }
        function toggleFS() { if(!document.fullscreenElement) document.documentElement.requestFullscreen(); else document.exitFullscreen(); }
        function toggleMenu(id) { document.querySelectorAll('.screen').forEach(s=>s.style.display='none'); document.getElementById('m-'+id).style.display='flex'; }

        /** --- 6. МУЛЬТИПЛЕЕР (PEERJS) --- **/
        function initNet(mode) {
            const id = document.getElementById('srv-id').value || 'room101';
            peer = mode === 'host' ? new Peer('ac_v12_'+id) : new Peer();
            peer.on('open', (myId) => {
                if(mode === 'host') {
                    console.log("ID комнаты: " + myId);
                    peer.on('connection', c => { conn = c; handleNet(); });
                } else {
                    conn = peer.connect('ac_v12_'+id);
                    handleNet();
                }
            });
        }

        function handleNet() {
            conn.on('data', d => {
                if(d.t === 'mv') {
                    if(!players.other) { players.other = createSteveModel(0xff0000); scene.add(players.other); }
                    players.other.position.set(d.x, d.y, d.z); players.other.rotation.y = d.r;
                }
                if(d.t === 'pl') createBlock(d.x, d.y, d.z, d.s);
                if(d.t === 'br') {
                    const b = world.get(`${d.x},${d.y},${d.z}`);
                    if(b) { scene.remove(b); world.delete(`${d.x},${d.y},${d.z}`); }
                }
            });
        }
    </script>
</body>
</html>
